<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rolling Paper</title>
    <style>
      :root{
        --bg: #f7fafc;
        --board: #fff;
        --border: #e5e7eb;
        --text: #111827;
        --muted: #6b7280;
      }
      *{ box-sizing: border-box }
      body{ margin:0; background: var(--bg); color: var(--text); font: 14px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", "맑은 고딕", sans-serif }
      .wrap{ max-width: 960px; margin: 20px auto; padding: 0 16px }
      header{ display:flex; align-items:center; justify-content:space-between; padding: 12px 0 }
      h1{ margin:0; font-size: 18px }
      .panel{ border:1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,.04) }
      .board{ position: relative; min-height: 520px; padding: 12px 18px 18px; display: flex; flex-direction: column; gap: 12px }
      .note{ position: relative; border-radius: 10px; padding: 12px 12px 16px 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06); word-break: break-word; white-space: pre-wrap }
      .note .who{ font-size: 12px; color: var(--muted); margin-bottom: 6px }
      .note .txt{ font-size: 14px }
      .note .del{ position: absolute; top: 6px; right: 8px; border:none; background: transparent; color:#333; opacity:.5; cursor:pointer }
      .note .votes{ position: absolute; top: 8px; right: 34px; font-size: 12px; color: var(--muted) }
      .form{ padding: 12px 12px 0; display:grid; grid-template-columns: 1fr 120px; gap: 12px; border-bottom:1px solid var(--border) }
      .row{ display:flex; gap: 8px }
      input, textarea, select{ width: 100%; border:1px solid var(--border); border-radius: 10px; padding: 10px 12px; font: inherit }
      textarea{ min-height: 90px; resize: vertical }
      button.submit{ border:none; background: #2f80ed; color:#fff; border-radius: 10px; font-weight: 600 }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>JS Rolling Paper</h1>
      </header>
      <div class="panel">
        <form id="form" class="form">
          <div class="col">
            <div class="row">
              <input id="author" placeholder="작성자 (선택)" />
            </div>
            <textarea id="text" placeholder="메시지를 입력하세요"></textarea>
          </div>
          <button class="submit">Submit</button>
        </form>
        <div id="board" class="board"></div>
      </div>
    </div>

    <script>
      const board = document.getElementById('board');
      const form = document.getElementById('form');
      const authorEl = document.getElementById('author');
      const textEl = document.getElementById('text');

      // color selection removed

      try{ const saved = localStorage.getItem('rp_name'); if (saved) authorEl.value = saved; }catch{}
      authorEl.addEventListener('input', () => { try{ localStorage.setItem('rp_name', authorEl.value); }catch{} });
      function noteEl(note){
        const d = document.createElement('div');
        d.className = 'note';
        d.style.background = note.color || '#fff';
                d.innerHTML = `<div class="who">${(note.author||'anon')}</div><div class="txt"></div>`;
        d.querySelector('.txt').innerHTML = note.text || '';
        // show current delete votes (x/3)
        const votesEl = document.createElement('span');
        votesEl.className = 'votes';
        const setVotes = (v) => { votesEl.textContent = v > 0 ? `(${v}/3)` : ''; };
        setVotes(Number(note.votes || 0));
        d.appendChild(votesEl);
        const del = document.createElement('button');
        del.className = 'del';
        del.textContent = '✕';
        del.title = '삭제 (3표 필요)';
        del.addEventListener('click', async () => {
          try{
            const r = await fetch('/api/notes/' + note.id, { method:'DELETE' });
            if (r.status === 202) { const j = await r.json().catch(()=>({})); setVotes(Number(j.votes||0)); }
          }catch{}
        });
        d.appendChild(del);
        d.dataset.id = note.id;
        d.dataset.at = String(note.at || 0);
        return d;
      }

      function addNote(note){
        const el = noteEl(note);
        const at = Number(note.at || 0);
        let inserted = false;
        for (const child of Array.from(board.children)){
          const cat = Number((child.getAttribute && child.getAttribute('data-at')) || 0);
          if (at >= cat) { board.insertBefore(el, child); inserted = true; break; }
        }
        if (!inserted) board.appendChild(el);
      }
      function removeNote(id){
        const el = board.querySelector('[data-id="' + id + '"]');
        if (el) el.remove();
      }

      async function loadAll(){
        try{
          const res = await fetch('/api/notes');
          const list = await res.json();
          board.innerHTML = '';
          list.sort((a,b) => b.at - a.at).forEach(addNote);
        }catch{}
      }

      // SSE + polling fallback
      let usingSSE = false; let lastAt = 0;
      function apply(ev){
        if (!ev) return;
        if (typeof ev.at === 'number') lastAt = Math.max(lastAt, ev.at);
        if (ev.type === 'created' && ev.note) addNote(ev.note);
        if (ev.type === 'deleted' && ev.id) removeNote(ev.id);
        if (ev.type === 'voted' && ev.id) {
          const el = board.querySelector('[data-id="' + ev.id + '"]');
          if (el){
            const v = el.querySelector('.votes');
            if (v) v.textContent = ev.votes > 0 ? `(${ev.votes}/3)` : '';
          }
        }
      }
      async function pollOnce(){
        try{ const r = await fetch('/api/poll?since=' + lastAt); if (!r.ok) return; const arr = await r.json(); if (Array.isArray(arr)) arr.forEach(apply); }catch{}
      }
      let polling = false;
      async function pollLoop(){ if (polling) return; polling = true; while(!usingSSE){ await pollOnce(); } polling = false; }
      try{ const es = new EventSource('/events'); es.addEventListener('open', () => { usingSSE = true; }); es.addEventListener('message', (ev) => { try{ apply(JSON.parse(ev.data)); }catch{} }); setTimeout(()=>{ if(!usingSSE) pollLoop(); }, 2000); }catch{ pollLoop(); }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const author = authorEl.value.trim();
        const text = textEl.value.trim();
        if (!text) return;
        try{
          await fetch('/api/notes', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ author, text }) });
          textEl.value = '';
          textEl.focus();
        }catch{}
      });

      loadAll();
    </script>
  </body>
  </html>
