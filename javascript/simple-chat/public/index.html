<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JS Simple Chat</title>
    <style>
      :root{
        --bg: #f5f6f7;            /* site body bg */
        --panel: #ffffff;         /* card / bubbles */
        --me: #fee500;            /* Kakao yellow */
        --text: #111827;          /* primary text */
        --muted: #6b7280;         /* secondary text */
        --border: #e5e7eb;
        --accent: #2f80ed;        /* send button color */
      }
      * { box-sizing: border-box }
      body { margin:0; background: var(--bg); color: var(--text); font: 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Malgun Gothic", "맑은 고딕", "Noto Sans KR", sans-serif; }
      .wrap { width: 100%; max-width: 660px; margin: 24px auto; background: var(--panel); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.06); overflow: hidden }
      header { background: var(--panel); border-bottom: 1px solid var(--border); padding: 14px 16px; font-weight: 700 }
      .chat { height: 720px; overflow: auto; padding: 12px 10px 8px; background: #ececed }
      .row { display: flex; gap: 8px; margin: 6px 0; align-items: flex-end; width: 100% }
      .row.me { justify-content: flex-end }
      .avatar { width: 30px; height: 30px; border-radius: 50%; background: #ddd; color:#555; display:flex; align-items:center; justify-content:center; font-size: 12px; flex: 0 0 30px }
      .bubble { display: inline-block; width: -moz-fit-content; width: fit-content; max-width: 100%; min-width: 44px; padding: 10px 12px; border-radius: 16px; background: var(--panel); box-shadow: 0 1px 0 rgba(0,0,0,.03); word-break: break-word; white-space: pre-wrap; overflow-wrap: anywhere }
      .meta { font-size: 11px; color: var(--muted); margin: 0 6px }
      .row.other .bubble { border: 1px solid var(--border); border-top-left-radius: 6px }
      .row.me .bubble { background: var(--me); border: 1px solid #f5d000; border-top-right-radius: 6px }
      .name { font-size: 12px; color: var(--muted); margin: 0 0 4px 2px }
      .stack { display:flex; flex-direction: column; align-items: stretch; max-width: calc(100% - 60px) }
      .row.other .stack { max-width: calc(100% - 90px) } /* avatar + time margin */
      .row.me .stack { max-width: calc(100% - 60px) }
      .sys { color: var(--muted); text-align: center; margin: 10px 0; font-size: 12px }
      /* input bar */
      .bar { display:flex; gap:8px; padding: 10px; background: var(--panel); border-top:1px solid var(--border) }
      .who { width: 150px; border:1px solid var(--border); border-radius: 12px; padding: 10px 12px; font-size: 14px }
      .input { flex:1 1 auto; border:1px solid var(--border); border-radius: 12px; padding: 10px 12px; font-size: 14px }
      .send { border:none; background: var(--accent); color:#fff; border-radius: 12px; padding: 0 16px; font-weight: 600 }
      .send:disabled{ opacity:.6 }
      @media (max-width: 640px){ .wrap{ margin:12px } .who { width: 120px } .chat{ height: 60vh } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>JS Simple Chat</header>
      <div id="log" class="chat"></div>
      <div class="bar">
        <input id="name" class="who" placeholder="nickname" />
        <input id="msg" class="input" placeholder="message" />
        <button id="send" class="send">Send</button>
      </div>
    </div>
    <script>
      const log = document.getElementById('log');
      const nameEl = document.getElementById('name');
      const msgEl = document.getElementById('msg');
      const btn = document.getElementById('send');

      try { const saved = localStorage.getItem('nick'); if(saved) nameEl.value = saved; } catch {}

      function initials(n){
        const s = (n||'anon').trim();
        const parts = s.split(/\s+|[-_]/).filter(Boolean);
        const a = (parts[0]||'a')[0];
        const b = (parts[1]||'')[0] || '';
        return (a + b).toUpperCase();
      }

      function scrollToBottom(){ log.scrollTop = log.scrollHeight; }

      function addSystem(text){
        const el = document.createElement('div');
        el.className = 'sys';
        el.textContent = text;
        log.appendChild(el);
        scrollToBottom();
      }

      function addChat(name, text, at){
        const me = (nameEl.value.trim() || 'anon');
        const isMe = (name || 'anon') === me;

        const row = document.createElement('div');
        row.className = 'row ' + (isMe ? 'me' : 'other');

        const meta = document.createElement('div');
        meta.className = 'meta';
        const ts = new Date(at || Date.now());
        meta.textContent = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if(!isMe){
          const av = document.createElement('div');
          av.className = 'avatar';
          av.textContent = initials(name);
          row.appendChild(av);
        }

        const stack = document.createElement('div');
        stack.className = 'stack';
        if(!isMe){
          const nm = document.createElement('div');
          nm.className = 'name';
          nm.textContent = name || 'anon';
          stack.appendChild(nm);
        }
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        stack.appendChild(bubble);

        row.appendChild(stack);
        row.appendChild(meta);

        log.appendChild(row);
        scrollToBottom();
      }

      nameEl.addEventListener('input', () => { try{ localStorage.setItem('nick', nameEl.value); }catch{} });

      // SSE + Polling fallback
      let usingSSE = false;
      let lastAt = 0;

      function apply(msg){
        if (!msg) return;
        if (typeof msg.at === 'number') lastAt = Math.max(lastAt, msg.at);
        if (msg.type === 'system') addSystem(msg.text);
        if (msg.type === 'chat') addChat(msg.name || 'anon', msg.text || '', msg.at);
      }

      async function pollOnce(){
        try{
          const res = await fetch(`/poll?since=${lastAt}`);
          if (!res.ok) return;
          const list = await res.json();
          if (Array.isArray(list)) list.forEach(apply);
        }catch{}
      }

      let polling = false;
      async function pollLoop(){
        if (polling) return;
        polling = true;
        while(!usingSSE){
          await pollOnce();
          // next iteration immediately; server long-poll holds up to ~25s
        }
        polling = false;
      }

      try{
        const es = new EventSource('/events');
        es.addEventListener('open', () => { usingSSE = true; addSystem('Connected. Say hello!'); });
        es.addEventListener('message', (ev) => { try{ apply(JSON.parse(ev.data)); }catch{} });
        es.addEventListener('error', () => { if (es.readyState === EventSource.CLOSED) addSystem('Disconnected.'); });
        // if SSE fails to open within 2s, start long-poll loop
        setTimeout(() => { if (!usingSSE) pollLoop(); }, 2000);
      }catch{
        pollLoop();
      }

      async function send() {
        const name = nameEl.value.trim() || 'anon';
        const text = msgEl.value.trim();
        if (!text) return;
        btn.disabled = true;
        try {
          await fetch('/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, text }) });
          msgEl.value = '';
        } catch {}
        btn.disabled = false;
        msgEl.focus();
      }
      msgEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
      btn.addEventListener('click', send);
    </script>
  </body>
  </html>
